{% extends "admin_panel_base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Dropdown for selecting community -->
    <div class="mb-3">
        <label for="communitySelect" class="form-label">Select Community:</label>
        <select class="form-select" id="communitySelect" onchange="filterCommunity()">
            <option value="">All Communities ({{ total_vaults }})</option>
            {% for community in communities %}
            <option value="{{ community.id }}">{{ community.name }} ({{ community.vault_count }})</option>
            {% endfor %}
        </select>
    </div>


    <!-- Display Unscheduled Vault posts -->
    <h2 class="mt-4">Unscheduled Vaults</h2>
    <div id="unscheduledVaults" class="row">
        {% for vault in unscheduled_vaults %}
        <div class="col-12 mb-4">
            <div class="card" data-vault-id="{{ vault.id }}">
                {% include 'vault_card.html' %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Display Scheduled Vault posts -->
    <h2>Scheduled Vaults</h2>
    <div id="scheduledVaults" class="accordion">
        {% for date, vaults in grouped_vaults.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ date.strftime('%Y%m%d') }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ date.strftime('%Y%m%d') }}" aria-expanded="false" aria-controls="collapse{{ date.strftime('%Y%m%d') }}">
                    {{ date.strftime('%Y-%m-%d') }} ({{ vaults|length }} vaults)
                </button>
            </h2>
            <div id="collapse{{ date.strftime('%Y%m%d') }}" class="accordion-collapse collapse" aria-labelledby="heading{{ date.strftime('%Y%m%d') }}">
                <div class="accordion-body">
                    {% for vault in vaults %}
                    <div class="card mb-3" data-vault-id="{{ vault.id }}">
                        <!-- Vault content (same as before) -->
                        {% include 'vault_card.html' %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    
</div>
<script>



function toggleComments(vaultId) {
    var commentSection = document.getElementById('commentsSection' + vaultId);
    var toggleIcon = document.getElementById('toggleIcon' + vaultId);
    
    if (commentSection.style.display === 'none') {
        commentSection.style.display = 'block';
        toggleIcon.textContent = '▲';
    } else {
        commentSection.style.display = 'none';
        toggleIcon.textContent = '▼';
    }
}

    document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.scheduled-time').forEach(function(el) {
        var utcTime = new Date(el.dataset.time);
        el.textContent = utcTime.toLocaleString();
    });
});

function deleteVault(vaultId) {
    if (confirm('Are you sure you want to delete this vault?')) {
        fetch('/delete_vault/' + vaultId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                // Try to remove the vault card from the UI
                const vaultCard = document.querySelector(`.card[data-vault-id="${vaultId}"]`);
                if (vaultCard) {
                    vaultCard.remove();
                } else {
                    // If we can't find the card, reload the page
                    window.location.reload();
                }
                alert('Vault deleted successfully');
            } else {
                alert('Failed to delete vault: ' + data.error);
            }
        }).catch(error => {
            console.error('Error deleting vault:', error);
            alert('Error deleting vault. See console for details.');
        });
    }
}


function scheduleVault(vaultId) {
    flatpickr("#schedulePicker" + vaultId, {
        enableTime: true,
        dateFormat: "Z",
        altInput: true,
        altFormat: "F j, Y at h:i K",
        minDate: "today",
        time_24hr: false,
        onClose: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                const utcDate = selectedDates[0].toUTCString();
                fetch('/schedule_vault/' + vaultId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({scheduled_at: utcDate})
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Failed to schedule: ' + data.error);
                    }
                }).catch(error => {
                    console.error('Error scheduling vault:', error);
                    alert('Error scheduling vault. See console for details.');
                });
            }
        }
    });
}


function cancelSchedule(vaultId) {
        if (confirm('Are you sure you want to cancel the scheduling?')) {
            fetch('/cancel_schedule/' + vaultId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Failed to cancel scheduling: ' + data.error);
                }
            }).catch(error => {
                console.error('Error cancelling scheduling:', error);
                alert('Error cancelling scheduling. See console for details.');
            });
        }
    }

function filterCommunity() {
    var communityId = document.getElementById('communitySelect').value;
    var url = new URL(window.location.href);
    url.searchParams.set('community_id', communityId);
    window.location.href = url.href;
}
function editVault(vaultId) {
    var url = `/edit-vault/${vaultId}`;
    window.location.href = url;
}
function markAsPosted(vaultId) {
    fetch('/mark_vault_as_posted/' + vaultId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to mark as posted: ' + data.error);
        }
    }).catch(error => {
        console.error('Error marking vault as posted:', error);
        alert('Error marking vault as posted. See console for details.');
    });
}
</script>
{% endblock %}



