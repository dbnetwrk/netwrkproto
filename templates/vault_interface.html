{% extends "admin_panel_base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Dropdown for selecting community -->
    <div class="mb-3">
        <label for="communitySelect" class="form-label">Select Community:</label>
        <select class="form-select" id="communitySelect" onchange="filterCommunity()">
            <option value="">All Communities ({{ total_vaults }})</option>
            {% for community in communities %}
            <option value="{{ community.id }}">{{ community.name }} ({{ community.vault_count }})</option>
            {% endfor %}
        </select>
    </div>
    <!-- Display Vault posts -->
    <div id="vaultPosts" class="row">
        {% for vault in vaults %}
        <div class="col-12 mb-4">
            <div class="card" data-vault-id="{{ vault.id }}">
                <div class="card-body">
                    <h5 class="card-title">{{ vault.title }}</h5>
                    <p class="card-text">{{ vault.content }}</p>
                    <p class="card-text">Seeder: {{ vault.official_seeder.full_name }}</p>
                    <p class="card-text"><small class="text-muted">Created: {{ vault.created_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
                    <button onclick="editVault({{ vault.id }})" class="btn btn-primary">Edit</button>
                    {% if not vault.is_posted %}
                    <button onclick="markAsPosted({{ vault.id }})" class="btn btn-success">Mark as Posted</button>
                    {% endif %}
                    <button onclick="deleteVault({{ vault.id }})" class="btn btn-danger">Delete</button>
                    
                    <!-- Comments Section -->
                    <div class="mt-3">
                        <h6>Comments:</h6>
                        {% if vault.comments %}
                            {% for comment in vault.comments if comment.parent_id is none %}
                            <div class="card mt-2">
                                <div class="card-body">
                                    <p class="card-text">{{ comment.content }}</p>
                                    <p class="card-text"><small class="text-muted">By: {{ comment.official_seeder.full_name }} on {{ comment.posted_time.strftime('%Y-%m-%d %H:%M') }}</small></p>
                                    
                                    <!-- Replies -->
                                    {% for reply in comment.replies %}
                                    <div class="card mt-2 ml-4">
                                        <div class="card-body">
                                            <p class="card-text">{{ reply.content }}</p>
                                            <p class="card-text"><small class="text-muted">By: {{ reply.official_seeder.full_name }} on {{ reply.posted_time.strftime('%Y-%m-%d %H:%M') }}</small></p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>No comments yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>

function deleteVault(vaultId) {
    if (confirm('Are you sure you want to delete this vault?')) {
        fetch('/delete_vault/' + vaultId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                // Try to remove the vault card from the UI
                const vaultCard = document.querySelector(`.card[data-vault-id="${vaultId}"]`);
                if (vaultCard) {
                    vaultCard.remove();
                } else {
                    // If we can't find the card, reload the page
                    window.location.reload();
                }
                alert('Vault deleted successfully');
            } else {
                alert('Failed to delete vault: ' + data.error);
            }
        }).catch(error => {
            console.error('Error deleting vault:', error);
            alert('Error deleting vault. See console for details.');
        });
    }
}


function filterCommunity() {
    var communityId = document.getElementById('communitySelect').value;
    var url = new URL(window.location.href);
    url.searchParams.set('community_id', communityId);
    window.location.href = url.href;
}
function editVault(vaultId) {
    var url = `/edit-vault/${vaultId}`;
    window.location.href = url;
}
function markAsPosted(vaultId) {
    fetch('/mark_vault_as_posted/' + vaultId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to mark as posted: ' + data.error);
        }
    }).catch(error => {
        console.error('Error marking vault as posted:', error);
        alert('Error marking vault as posted. See console for details.');
    });
}
</script>
{% endblock %}



