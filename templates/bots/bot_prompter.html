{% extends "admin_panel_base.html" %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Bot Prompter</h1>
    <div class="row">
        <div class="col-md-4">
            <select id="bot-selector" class="form-select mb-3">
                <option value="">Select a bot</option>
                {% for bot in bots %}
                <option value="{{ bot.id }}" data-name="{{ bot.name }}" data-picture="{{ bot.profile_picture }}">{{ bot.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <button id="clear-conversation" class="btn btn-secondary mb-3" style="display: none;">Clear Conversation</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div id="chat-container" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
                <!-- Chat messages will be appended here -->
            </div>
            <form id="chat-form">
                <div class="input-group">
                    <input type="text" id="user-input" class="form-control" placeholder="Type your message..." required>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
        <div class="col-md-4">
            <div id="bot-info" class="text-center">
                <img id="bot-picture" src="" alt="Bot Profile Picture" class="img-fluid rounded-circle mb-2" style="max-width: 150px; display: none;">
                <h3 id="bot-name"></h3>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
    }
    .user-message {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        margin-left: auto;
    }
    .bot-message {
        background-color: #f1f1f1;
        align-self: flex-start;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const botSelector = document.getElementById('bot-selector');
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const botPicture = document.getElementById('bot-picture');
    const botName = document.getElementById('bot-name');
    const clearConversationBtn = document.getElementById('clear-conversation');
    let currentBotId = null;

    botSelector.addEventListener('change', function() {
        currentBotId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        botName.textContent = selectedOption.dataset.name;
        botPicture.src = selectedOption.dataset.picture;
        botPicture.style.display = 'inline-block';
        chatContainer.innerHTML = ''; // Clear chat when bot changes
        clearConversationBtn.style.display = currentBotId ? 'inline-block' : 'none';
    });

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentBotId) {
            alert('Please select a bot first');
            return;
        }
        const message = userInput.value.trim();
        if (message) {
            appendMessage('user', message);
            userInput.value = '';
            fetchBotResponse(message);
        }
    });

    clearConversationBtn.addEventListener('click', function() {
        if (currentBotId) {
            clearConversation(currentBotId);
        }
    });

    function appendMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
        messageDiv.textContent = message;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function fetchBotResponse(userMessage) {
        fetch(`/bot-prompter/${currentBotId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_input: userMessage }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                appendMessage('bot', 'Sorry, an error occurred. Please try again.');
            } else {
                appendMessage('bot', data.response);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            appendMessage('bot', 'Sorry, an error occurred. Please try again.');
        });
    }

    function clearConversation(botId) {
        fetch(`/bot-prompter/clear/${botId}`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            chatContainer.innerHTML = '';
            appendMessage('bot', 'Conversation has been cleared.');
        })
        .catch(error => {
            console.error('Error:', error);
            appendMessage('bot', 'Sorry, an error occurred while clearing the conversation.');
        });
    }
});
</script>
{% endblock %}