{% extends "admin_panel_base.html" %}

{% block content %}
<div class="container">
    <h2>Reddit Content Scraper</h2>
    <form method="POST" action="{{ url_for('reddit_scraper', content_type=content_type) }}">
        <div class="mb-3">
            <label for="subreddit" class="form-label">Subreddit Name</label>
            <select class="form-select" id="subreddit" name="subreddit">
                {% for subreddit in subreddits %}
                <option value="{{ subreddit.prompt }}" {% if subreddit.prompt == subreddit_name %}selected{% endif %}>
                    {{ subreddit.prompt }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="number_of_posts" class="form-label">Number of Posts</label>
            <input type="number" class="form-control" id="number_of_posts" name="number_of_posts" value="{{ number_of_posts | default(5) }}">
        </div>
        <div class="mb-3">
            <label for="sort_option" class="form-label">Sort Option</label>
            <select class="form-select" id="sort_option" name="sort_option">
                <option value="new" {% if sort_option == 'new' %}selected{% endif %}>New</option>
                <option value="hot" {% if sort_option == 'hot' %}selected{% endif %}>Hot</option>
                <option value="top" {% if sort_option == 'top' %}selected{% endif %}>Top</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Scrape</button>
    </form>


<div class="row mt-4">
    {% for result in results %}
    <div class="col-md-12 mb-3" id="postCard{{ loop.index }}">  <!-- Adjusted from col-md-4 to col-md-12 -->
        <div class="card">
            <!-- Display image if it exists in the result -->
            {% if result.image %}
                <img src="{{ url_for('static', filename=result.image) }}" class="card-img-top img-fluid">
            {% endif %}
            <div class="card-body">
                <!-- Display title and content if they exist in the result -->
                {% if result.title %}
                    <h4 class="card-title">{{ result.title }}</h4>
                {% endif %}
                {% if result.content %}
                    <p class="card-text">{{ result.content | truncate_lines | safe }}</p>
                {% endif %}

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal{{ loop.index }}">
                    Schedule Post
                </button>

                <!-- Modal -->
                <div class="modal fade" id="scheduleModal{{ loop.index }}" tabindex="-1" aria-labelledby="scheduleModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="scheduleModalLabel{{ loop.index }}">Schedule Post</h5>
                                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" action="{{ url_for('schedule_post') }}" enctype="multipart/form-data" data-index="{{ loop.index }}">
                                    <div class="mb-3">
                                        <!-- Show an image preview -->
                                        {% if result.image %}
                                            <img src="{{ url_for('static', filename=result.image) }}" class="card-img-top img-fluid">
                                            <input type="hidden" name="existing_image" value="{{ result.image }}">
                                        {% endif %}
                                        <!--- <label for="image" class="form-label">Upload Image (re-upload if necessary)</label>
                                        <input type="file" class="form-control" name="image"> -->
                                        <!-- Send the existing image path as a hidden field -->
                                        <div class="mb-3">
                                        <label for="community_id" class="form-label">Select Community</label>
                                        <select class="form-select" name="community_id" id="community_id{{ loop.index }}" onchange="updateSeeders(this.value, {{ loop.index }})">
    {% for community in communities %}
    <option value="{{ community.id }}">{{ community.name }}</option>
    {% endfor %}
</select>

                                    </div>
                                    <div class="mb-3">
                                        <label for="user_id" class="form-label">Select Seeder</label>
                                        <!-- In your HTML, change the ID to include the loop index -->
<select class="form-select" name="user_id" id="user_id{{ loop.index }}">
    <!-- Options will be populated by JavaScript -->
</select>

                                    </div>
                                    
                                    </div>
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control" name="title" value="{{ result.title }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="content" class="form-label">Content</label>
                                        <textarea class="form-control" id="content{{ loop.index }}" name="content">{{ result.content }}</textarea>

                                    </div>

                                <div class="mb-3">
    {% if not result.image %}
        <!-- Text input for custom prompt -->
        <small>I want you to take this piece of text {content} and...</small>
        <input type="text" class="form-control" id="customPrompt{{ loop.index }}" placeholder="Enter your custom prompt here">
        
        <!-- Button to invoke the AI function -->
        <button type="button" class="btn btn-secondary" onclick="makeConcise({{ loop.index }})">AI</button>
    {% endif %}
</div>


                                    
                                    <div class="mb-3">
                                        <label for="posted_time" class="form-label">Schedule Time</label>
                                        <input type="datetime-local" class="form-control" name="posted_time">
                                    </div>

                                    <!-- Hidden field for Reddit Post ID -->
                                    <input type="hidden" name="reddit_post_id" value="{{ result.reddit_post_id }}">
                                    
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>




</div>


<!-- Include jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
$(document).ready(function() {
    $('form[data-index]').on('submit', function(e) {
        e.preventDefault(); // Prevent the normal submission action
        var form = $(this);
        var postIndex = form.data('index'); // Get the index from the form's data-index attribute

        $.ajax({
            type: "POST",
            url: form.attr('action'),
            data: form.serialize(), // Serializes the form's elements.
            success: function(data) {
                $('#scheduleModal' + postIndex).modal('hide'); // Close the modal
                alert('Post Scheduled Successfully'); // Notify user
                $('#postCard' + postIndex).remove(); // Remove the post card from the list
            }
        });
    });
});


function makeConcise(index) {
    var promptText = document.getElementById('customPrompt' + index).value;
    var content = document.getElementById('content' + index).value; // Assuming you have an element with this ID for content

    var request = new XMLHttpRequest();
    request.open('POST', '{{ url_for("make_concise") }}', true);
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
            var resp = JSON.parse(request.responseText);
            document.getElementById('content' + index).value = resp.concise_text;
        } else {
            console.error('Error on server');
        }
    };
    request.onerror = function() {
        console.error('Error connecting');
    };
    request.send(JSON.stringify({ content: content, prompt_text: promptText }));
}



function updateSeeders(communityId, index) {
    fetch(`/get_seeders_community/${communityId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            const seederSelect = document.getElementById('user_id' + index); // Adjust ID reference
            seederSelect.innerHTML = ''; // Clear existing options
            data.forEach(seeder => {
                const option = document.createElement('option');
                option.value = seeder.id;
                option.textContent = seeder.name;
                seederSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching seeders:', error));
}


</script>



{% endblock %}

